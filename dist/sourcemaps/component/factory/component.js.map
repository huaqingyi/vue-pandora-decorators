{"version":3,"sources":["../src/component/factory/component.ts"],"names":[],"mappings":"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","file":"../../../component/factory/component.js","sourcesContent":["import { extend, isFunction } from 'lodash';\nimport {\n    ComponentOptionsBase, ComponentOptionsMixin, ComputedOptions, defineComponent,\n    EmitsOptions, MethodOptions, ComputedRef, isRef, Ref\n} from 'vue';\nimport { PureComponent, PureComponentClass } from '../component';\nimport { ContextFactory } from './context';\nimport { Factory } from './factory';\n\n/*\n * @FilePath: /vue3-template/src/libs/decorators/component/factory/component.ts\n * @Descripttion: \n * @version: \n * @Author: 易华青\n * @Date: 2020-12-11 10:06:14\n * @LastEditors: huaqingyi\n * @LastEditTime: 2020-12-11 17:27:33\n * @debugger: \n */\ntype FactoryContextDataInfo = string | number | boolean | object | Function | {} | [];\n\nexport interface FactoryContextData {\n    [x: string]: FactoryContextDataInfo | Array<FactoryContextData> | Promise<FactoryContextDataInfo> | ComputedRef<FactoryContextData> | FactoryContextData | Promise<FactoryContextData>;\n}\n\nexport enum ProxyActions {\n    RENDER = 'render',\n}\n\nexport class ComponentFactory<\n    CC extends PureComponentClass<PureComponent>,\n    Props = any, RawBindings = any, D = any, C extends ComputedOptions = any, M extends MethodOptions = any,\n    Mixin extends ComponentOptionsMixin = any, Extends extends ComponentOptionsMixin = any,\n    E extends EmitsOptions = any, EE extends string = string, Defaults = {}\n    > extends Factory {\n\n    public isRender?: boolean;\n\n    constructor(\n        public target: CC,\n        public options?: ComponentOptionsBase<Props, RawBindings, D, C, M, Mixin, Extends, E, EE, Defaults>,\n    ) {\n        super();\n    }\n\n    private isProxy(proxy: any & PureComponent) {\n        return proxy && proxy._root && isFunction(proxy._root) && proxy._root() === PureComponent;\n    }\n\n    private synchro(data: any | Ref<any>) {\n        if (isRef(data)) return data.value;\n        return data;\n    }\n\n    private proxyRender(ctx: FactoryContextData & any, proxy: any & PureComponent) {\n        return new Proxy(ctx, {\n            get: (target, key: string) => {\n                if (this.isProps(proxy, key)) {\n                    return target.props[key];\n                }\n                if (this.isDynamic(proxy, key)) {\n                    proxy[key] = this.synchro(target[key]);\n                    return target[key];\n                }\n                if (this.isComputed(proxy, key)) {\n                    proxy[key] = this.synchro(target[key]);\n                    return target[key];\n                }\n                if (this.isState(proxy, key)) {\n                    proxy[key] = this.synchro(target[key]);\n                    return target[key];\n                }\n                return isFunction(proxy[key]) ? proxy[key].bind(proxy) : proxy[key];\n            },\n            set: (target, key: string, value) => {\n                if (this.isProps(proxy, key)) { return target.props[key] = value; }\n\n                if (this.isDynamic(proxy, key)) {\n                    target[key] = value;\n                    return true;\n                }\n\n                if (this.isComputed(proxy, key)) {\n                    return true;\n                }\n\n                if (this.isState(proxy, key)) {\n                    return true;\n                }\n\n                proxy[key] = value;\n\n                return true;\n            }\n        });\n    }\n\n    public render(\n        target: any, key: string,\n        ctx: FactoryContextData & any, cache: any,\n        $props: any, $setup: any, $data: any, $options: any,\n    ) {\n        const proxy = ctx[this.proxyKey];\n        let useCtx = ctx;\n        if (this.isProxy(proxy)) {\n            useCtx = this.proxyRender(ctx, proxy);\n        }\n        if (!target[key]) { throw new Error(`${target} -> ${key} of undefined ...`); }\n        return target[key].apply(this, [useCtx, cache, $props, $setup, $data, $options]);\n    }\n\n    public output() {\n        const Target = this.target;\n        Target.prototype.state = {};\n        const props = extend(this.options ? this.options.props || {} : {}, Target.prototype._props());\n        // console.log(props);\n        const component = new Proxy<any>(defineComponent({\n            ...this.options ? this.options : {},\n            props,\n            setup: (...args) => {\n                // initialization @component decorator class with of setup hook .\n                const comp = new Target(...args);\n                // initialization reactived data hooks .\n                const { onReactived, reactived, didReactived }: any = comp;\n                // startup, this's before the setup .\n                onReactived && onReactived();\n                let setupData = comp.setup(...args);\n                if (!setupData) { setupData = { ...comp }; }\n                else { setupData = { ...setupData }; }\n                // setup return context data .\n                reactived && reactived(setupData);\n                // proxy to fatory, fatory is merge ctx typeof proxy .\n                const context = new ContextFactory(setupData, Target, comp);\n                let proxyFatory = context.output<FactoryContextData>();\n                // did reactived ...\n                if (didReactived) {\n                    const nproxyFatory = didReactived(proxyFatory);\n                    if (nproxyFatory) proxyFatory = nproxyFatory;\n                }\n                return proxyFatory;\n            },\n        }), {\n            get: (target, key: string) => {\n                switch (key) {\n                    case ProxyActions.RENDER:\n                        if (!this.isRender) {\n                            this.isRender = true;\n                            return (ctx: any, cache: any, $props: any, $setup: any, $data: any, $options: any) => {\n                                return this.render(target, key, ctx, cache, $props, $setup, $data, $options);\n                            };\n                        }\n                        return target[key];\n                    default: return target[key];\n                }\n            }\n        });\n        component._class = () => Target;\n        return component;\n    }\n}\n"]}